<% provide(:title, "Pub Thursday Audit") %>
<% provide(:description, "Due to a small bug of allowing users to have more than one active session, an audit needs to occur") %>

<h1>Pub Thursday Audit</h1>

<p class="well">
	Due to a severe security vulnerability on the Pub Tursday backed, clients have been able to trigger multiple check-in sessions inflating their time spent in pub.
	Here is an audit of sessions where they overlap another.
</p>

<h3>Worst Offenders</h2>
<table class="table">
	<% @worst_offenders.each do |offender| %>
	<tr>
		<td><img width="25" height="25" class="img-circle" src="<%= offender[:user][:photo] %>"></td>
		<td><%= offender[:user][:name] %></td>
		<td><%= offender[:number] %> dodgy sessions</td>
		<td><%= offender[:hours] %> dodgy hours</td>
	</tr>
	<% end %>
</table>

<h3>Raw Data</h3>
<section class="row">
  <% @users.each do |user| %>
	<article class="col-md-4">
		<h2>
			<img width="50" height="50" class="img-circle" src="<%= user[:photo] %>">
			<%= user[:name] %>
		</h2>
		<% user[:sessions].each do |session| %>
		<div style="margin-bottom:24px">
			<h4>
				<a href="/pub-thursday-audit/<%= session[:id] %>" target="_blank">
					<%= session[:start].strftime('%d/%m/%Y') %>
					<%= session[:start].strftime('%H:%M:%S') %> - <%= session[:end].strftime('%H:%M:%S') %>
				</a>
				</h4>
				<h6><%= session[:duration] %></h6>
				<h5><%= session[:location] %></h5>
				<dl style="font-family:monospace">
					<dt><%= session[:start].strftime('T%Y') %></dt>
					<dd><%= (TimeDifference.between(session[:end], session[:start]).in_seconds * 1000).ceil %></dd>
					<dt><%= session[:start].strftime('T%YM%m') %></dt>
					<dd><%= (TimeDifference.between(session[:end], session[:start]).in_seconds * 1000).ceil %></dd>
					<dt><%= session[:start].strftime('T%YW%V') %></dt>
					<dd><%= (TimeDifference.between(session[:end], session[:start]).in_seconds * 1000).ceil %></dd>
					<dt>Ttotal</dt>
					<dd><%= (TimeDifference.between(session[:end], session[:start]).in_seconds * 1000).ceil %></dd>
					<dt>totalTime</dt>
					<dd><%= (TimeDifference.between(session[:end], session[:start]).in_seconds).ceil %></dd>
					<dt>yearTime</dt>
					<dd><%= (TimeDifference.between(session[:end], session[:start]).in_seconds).ceil %></dd>
				</dl>
			<p>
				Overlaps with <a href="<%= session[:within][:url] %>" target="_blank">another session</a>
				<%= session[:within][:start].strftime('%H:%M:%S') %> -
				<%= session[:within][:end].strftime('%H:%M:%S') %>
				(<%= session[:within][:duration] %>)
				<% if session[:within][:longer] %>
					<b>Longer</b>
				<% end %>
			</p>
		</div>
		<% end %>
	</article>
	<% end %>
</section>
